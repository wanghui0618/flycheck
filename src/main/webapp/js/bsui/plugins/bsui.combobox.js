/**
 * dhcc-bsui-1.5.3.4
 * component:combobox
 * dependencies:combo
 */(function(c){function u(a,b){var d=c.data(a,"combobox");return c.bsui.indexOfArray(d.data,d.options.valueField,b)}function w(a,b){var d=c.data(a,"combobox").options,e=c(a).combobox("panel"),f=e.children("div.combobox-item-hover");f.length||(f=e.children("div.combobox-item-selected"));f.removeClass("combobox-item-hover");f.length?"next"==b?(f=f.nextAll("div.combobox-item:visible:not(.combobox-item-disabled):first"),f.length||(f=e.children("div.combobox-item:visible:not(.combobox-item-disabled):first"))):(f=f.prevAll("div.combobox-item:visible:not(.combobox-item-disabled):first"),f.length||(f=e.children("div.combobox-item:visible:not(.combobox-item-disabled):last"))):f=e.children("next"==b?"div.combobox-item:visible:not(.combobox-item-disabled):first":"div.combobox-item:visible:not(.combobox-item-disabled):last");f.length&&(f.addClass("combobox-item-hover"),e=d.finder.getRow(a,f))&&(c(a).combobox("scrollTo",e[d.valueField]),d.selectOnNavigation&&r(a,e[d.valueField]))}function r(a,b,d){var e=c.data(a,"combobox").options,f=c(a).combo("getValues");-1==c.inArray(b+"",f)&&(e.multiple?f.push(b):f=[b],h(a,f,d))}function x(a,b){c.data(a,"combobox");var d=c(a).combo("getValues"),e=c.inArray(b+"",d);0<=e&&(d.splice(e,1),h(a,d))}function h(a,b,d){var e=c.data(a,"combobox").options,f=c(a).combo("panel");c.isArray(b)||(b=b.split(e.separator));e.multiple||(b=b.length?[b[0]]:[""]);var g=c(a).combo("getValues");f.is(":visible")&&f.find(".combobox-item-selected").each(function(){var b=e.finder.getRow(a,c(this));b&&-1==c.bsui.indexOfArray(g,b[e.valueField])&&c(this).removeClass("combobox-item-selected")});c.map(g,function(d){if(-1==c.bsui.indexOfArray(b,d)){var f=e.finder.getEl(a,d);f.hasClass("combobox-item-selected")&&(f.removeClass("combobox-item-selected"),e.onUnselect.call(a,e.finder.getRow(a,d)))}});for(var l=null,k=[],q=[],h=0;h<b.length;h++){var m=b[h],y=m,t=e.finder.getRow(a,m);if(t){var y=t[e.textField],l=t,z=e.finder.getEl(a,m);z.hasClass("combobox-item-selected")||(z.addClass("combobox-item-selected"),e.onSelect.call(a,t))}k.push(m);q.push(y)}d||c(a).combo("setText",q.join(e.separator));e.showItemIcon&&(d=c(a).combobox("textbox"),d.removeClass("textbox-bgicon "+e.textboxIconCls),l&&l.iconCls&&(d.addClass("textbox-bgicon "+l.iconCls),e.textboxIconCls=l.iconCls));c(a).combo("setValues",k);f.triggerHandler("scroll")}function n(a,b,d){var e=c.data(a,"combobox"),f=e.options;e.data=f.loadFilter.call(a,b);f.view.render.call(f.view,a,c(a).combo("panel"),e.data);var g=c(a).combobox("getValues");c.bsui.forEach(e.data,!1,function(a){a.selected&&c.bsui.addArrayItem(g,a[f.valueField]+"")});f.multiple?h(a,g,d):h(a,g.length?[g[g.length-1]]:[],d);f.onLoadSuccess.call(a,b)}function p(a,b,d,e){var f=c.data(a,"combobox").options;b&&(f.url=b);d=c.extend({},f.queryParams,d||{});0!=f.onBeforeLoad.call(a,d)&&f.loader.call(a,d,function(c){n(a,c,e)},function(){f.onLoadError.apply(this,arguments)})}function B(a,b){function d(c){f.reversed?g.addClass("combobox-item-hover"):h(a,f.multiple?b?c:[]:c,!0)}var e=c.data(a,"combobox"),f=e.options,g=c(),l=f.multiple?b.split(f.separator):[b];if("remote"==f.mode)d(l),p(a,null,{q:b},!0);else{var k=c(a).combo("panel");k.find(".combobox-item-hover").removeClass("combobox-item-hover");k.find(".combobox-item,.combobox-group").hide();var q=e.data,n=[];c.map(l,function(b){var e=b=c.trim(b),d=void 0;g=c();for(var l=0;l<q.length;l++){var k=q[l];if(f.filter.call(a,b,k)){var h=k[f.valueField],m=k[f.textField],k=k[f.groupField],p=f.finder.getEl(a,h).show();m.toLowerCase()==b.toLowerCase()&&(e=h,f.reversed?g=p:r(a,h,!0));f.groupField&&d!=k&&(f.finder.getGroupEl(a,k).show(),d=k)}}n.push(e)});d(n)}}function A(a){var b=c(a),d=b.combobox("options"),e=b.combobox("panel").children("div.combobox-item-hover");if(e.length){e.removeClass("combobox-item-hover");var f=d.finder.getRow(a,e)[d.valueField];d.multiple?e.hasClass("combobox-item-selected")?b.combobox("unselect",f):b.combobox("select",f):b.combobox("select",f)}var g=[];c.map(b.combobox("getValues"),function(c){0<=u(a,c)&&g.push(c)});b.combobox("setValues",g);d.multiple||b.combobox("hidePanel")}function C(a){var b=c.data(a,"combobox").options;c(a).addClass("combobox-f");c(a).combo(c.extend({},b,{onShowPanel:function(){c(this).combo("panel").find("div.combobox-item:hidden,div.combobox-group:hidden").show();h(this,c(this).combobox("getValues"),!0);c(this).combobox("scrollTo",c(this).combobox("getValue"));b.onShowPanel.call(this)}}));var d=c(a).combo("panel");d.unbind(".combobox");for(var e in b.panelEvents)d.bind(e+".combobox",{target:a},b.panelEvents[e])}c.fn.combobox=function(a,b){if("string"==typeof a){var d=c.fn.combobox.methods[a];return d?d(this,b):this.combo(a,b)}a=a||{};return this.each(function(){var b=c.data(this,"combobox");b?c.extend(b.options,a):b=c.data(this,"combobox",{options:c.extend({},c.fn.combobox.defaults,c.fn.combobox.parseOptions(this),a),data:[]});if(b.options.dict){var d=b.options.dict,g=b.options.dictType,l={list:[],getted:!1,data:{}};c(document).data("pageCombos")||c(document).data("pageCombos",{});c(document).data("pageCombos")[g+"^"+d]||(c(document).data("pageCombos")[g+"^"+d]=l);-1===c.inArray(c(this),c(document).data("pageCombos")[g+"^"+d].list)&&c(document).data("pageCombos")[g+"^"+d].list.push(c(this));!b.options.data&&c(document).data("pageCombos")[g+"^"+d].getted&&c(document).data("pageCombos")[g+"^"+d].data&&(b.options.data=c(document).data("pageCombos")[g+"^"+d].data)}C(this);b.options.data?n(this,b.options.data):(b=c.fn.combobox.parseData(this),b.length&&n(this,b));p(this)})};c.fn.combobox.methods={options:function(a){var b=a.combo("options");return c.extend(c.data(a[0],"combobox").options,{width:b.width,height:b.height,originalValue:b.originalValue,disabled:b.disabled,readonly:b.readonly})},cloneFrom:function(a,b){return a.each(function(){c(this).combo("cloneFrom",b);c.data(this,"combobox",c(b).data("combobox"));c(this).addClass("combobox-f").attr("comboboxName",c(this).attr("textboxName"))})},getData:function(a){return c.data(a[0],"combobox").data},setValues:function(a,b){return a.each(function(){h(this,b)})},setValue:function(a,b){return a.each(function(){h(this,c.isArray(b)?b:[b])})},clear:function(a){return a.each(function(){h(this,[])})},reset:function(a){return a.each(function(){var a=c(this).combobox("options");a.multiple?c(this).combobox("setValues",a.originalValue):c(this).combobox("setValue",a.originalValue)})},loadData:function(a,b){return a.each(function(){n(this,b)})},reload:function(a,b){return a.each(function(){"string"==typeof b?p(this,b):(b&&(c(this).combobox("options").queryParams=b),p(this))})},select:function(a,b){return a.each(function(){r(this,b)})},unselect:function(a,b){return a.each(function(){x(this,b)})},scrollTo:function(a,b){return a.each(function(){var a=c.data(this,"combobox").options,e=c(this).combo("panel"),a=a.finder.getEl(this,b);a.length&&(0>=a.position().top?(a=e.scrollTop()+a.position().top,e.scrollTop(a)):a.position().top+a.outerHeight()>e.height()&&(a=e.scrollTop()+a.position().top+a.outerHeight()-e.height(),e.scrollTop(a)));e.triggerHandler("scroll")})}};c.fn.combobox.parseOptions=function(a){c(a);return c.extend({},c.fn.combo.parseOptions(a),c.parser.parseOptions(a,["valueField","textField","groupField","groupPosition","mode","method","url",{showItemIcon:"boolean",limitToList:"boolean"}]))};c.fn.combobox.parseData=function(a){function b(a,b){var f=c(a),g={};g[e.valueField]=void 0!=f.attr("value")?f.attr("value"):f.text();g[e.textField]=f.text();g.selected=f.is(":selected");g.disabled=f.is(":disabled");b&&(e.groupField=e.groupField||"group",g[e.groupField]=b);d.push(g)}var d=[],e=c(a).combobox("options");c(a).children().each(function(){if("optgroup"==this.tagName.toLowerCase()){var a=c(this).attr("label");c(this).children().each(function(){b(this,a)})}else b(this)});return d};var v=0;c.fn.combobox.defaults=c.extend({},c.fn.combo.defaults,{dict:null,dictType:"public",valueField:"value",textField:"text",groupPosition:"static",groupField:null,groupFormatter:function(a){return a},mode:"local",method:"post",url:null,data:null,queryParams:{},showItemIcon:!1,limitToList:!1,view:{render:function(a,b,d){var e=c.data(a,"combobox"),f=e.options;v++;e.itemIdPrefix="_bsui_combobox_i"+v;e.groupIdPrefix="_bsui_combobox_g"+v;e.groups=[];for(var g=[],l=void 0,k=0;k<d.length;k++){var h=d[k],n=h[f.textField],m=h[f.groupField];m?l!=m?(l=m,e.groups.push({value:m,startIndex:k,count:1}),g.push('\x3cdiv id\x3d"'+(e.groupIdPrefix+"_"+(e.groups.length-1))+'" class\x3d"combobox-group"\x3e'),g.push(f.groupFormatter?f.groupFormatter.call(a,m):m),g.push("\x3c/div\x3e")):e.groups[e.groups.length-1].count++:l=void 0;g.push('\x3cdiv id\x3d"'+(e.itemIdPrefix+"_"+k)+'" class\x3d"'+("combobox-item"+(h.disabled?" combobox-item-disabled":"")+(m?" combobox-gitem":""))+'"\x3e');f.showItemIcon&&h.iconCls&&g.push('\x3cspan class\x3d"combobox-icon '+h.iconCls+'"\x3e\x3c/span\x3e');g.push(f.formatter?f.formatter.call(a,h):n);g.push("\x3c/div\x3e")}c(b).html(g.join(""))}},keyHandler:{up:function(a){w(this,"prev");a.preventDefault()},down:function(a){w(this,"next");a.preventDefault()},left:function(a){},right:function(a){},enter:function(a){A(this)},query:function(a,b){B(this,a)}},inputEvents:c.extend({},c.fn.combo.defaults.inputEvents,{blur:function(a){var b=a.data.target,d=c(b).combobox("options");if(d.reversed||d.limitToList)d.blurTimer&&clearTimeout(d.blurTimer),d.blurTimer=setTimeout(function(){c(b).parent().length&&(d.reversed?c(b).combobox("setValues",c(b).combobox("getValues")):d.limitToList&&A(b),d.blurTimer=null)},50)}}),panelEvents:{mouseover:function(a){c(this).children("div.combobox-item-hover").removeClass("combobox-item-hover");var b=c(a.target).closest("div.combobox-item");b.hasClass("combobox-item-disabled")||b.addClass("combobox-item-hover");a.stopPropagation()},mouseout:function(a){c(a.target).closest("div.combobox-item").removeClass("combobox-item-hover");a.stopPropagation()},click:function(a){var b=c(this).panel("options").comboTarget;if(b){var d=c(b).combobox("options"),e=c(a.target).closest("div.combobox-item");if(e.length&&!e.hasClass("combobox-item-disabled")){var f=d.finder.getRow(b,e);f&&(d.blurTimer&&(clearTimeout(d.blurTimer),d.blurTimer=null),d.onClick.call(b,f),f=f[d.valueField],d.multiple?e.hasClass("combobox-item-selected")?x(b,f):r(b,f):c(b).combobox("setValue",f).combobox("hidePanel"),a.stopPropagation())}}},scroll:function(a){var b=c(this).panel("options").comboTarget;if(b){var d=c(b).combobox("options");if("sticky"==d.groupPosition){var e=c(this).children(".combobox-stick");e.length||(e=c('\x3cdiv class\x3d"combobox-stick"\x3e\x3c/div\x3e').appendTo(this));e.hide();var f=c(b).data("combobox");c(this).children(".combobox-group:visible").each(function(){var a=c(this),h=d.finder.getGroup(b,a),h=d.finder.getEl(b,f.data[h.startIndex+h.count-1][d.valueField]);if(0>a.position().top&&0<h.position().top)return e.show().html(a.html()),!1})}}}},filter:function(a,b){var d=c(this).combobox("options");return 0<=b[d.textField].toLowerCase().indexOf(a.toLowerCase())},formatter:function(a){var b=c(this).combobox("options");return a[b.textField]},loader:function(a,b,d){var e=c(this).combobox("options");if(!e.url||e.dict)return!1;c.ajax({type:e.method,url:e.url,data:a,dataType:"json",success:function(a){a.rows&&a.rows.length?b(a.rows):b(a)},error:function(){d.apply(this,arguments)}})},loadFilter:function(a){return a},finder:{getEl:function(a,b){var d=u(a,b),d=c.data(a,"combobox").itemIdPrefix+"_"+d;return c("#"+d)},getGroupEl:function(a,b){var d=c.data(a,"combobox"),e=c.bsui.indexOfArray(d.groups,"value",b);return c("#"+(d.groupIdPrefix+"_"+e))},getGroup:function(a,b){var d=c.data(a,"combobox"),e=b.attr("id").substr(d.groupIdPrefix.length+1);return d.groups[parseInt(e)]},getRow:function(a,b){var d=c.data(a,"combobox"),e=b instanceof c?b.attr("id").substr(d.itemIdPrefix.length+1):u(a,b);return d.data[parseInt(e)]}},onBeforeLoad:function(a){},onLoadSuccess:function(a){},onLoadError:function(){},onSelect:function(a){},onUnselect:function(a){},onClick:function(a){}})})(jQuery);