(function(b){function m(a){function f(c){(c=b(a).datagrid("getEditor",{index:e.editIndex,field:c}))?c.target.focus():(c=b(a).datagrid("getEditors",e.editIndex),c.length&&c[0].target.focus())}var e=b.data(a,"edatagrid").options;b(a).datagrid(b.extend({},e,{onDblClickCell:function(c,d,g){e.editing&&(b(this).edatagrid("editRow",c),f(d));e.onDblClickCell&&e.onDblClickCell.call(a,c,d,g)},onClickCell:function(c,d,g){e.editing&&0<=e.editIndex&&(b(this).edatagrid("editRow",c),f(d));e.onClickCell&&e.onClickCell.call(a,c,d,g)},onAfterEdit:function(c,d){e.editIndex=-1;var f=d.isNewRecord?e.saveUrl:e.updateUrl;f?b.post(f,d,function(f){if(f.isError)b(a).edatagrid("cancelRow",c),b(a).edatagrid("selectRow",c),b(a).edatagrid("editRow",c),e.onError.call(a,c,f);else{f.isNewRecord=null;b(a).datagrid("updateRow",{index:c,row:f});if(e.tree){f=d[e.idField||"id"];var g=b(e.tree),k=g.tree("find",f);k?(k.text=d[e.treeTextField],g.tree("update",k)):(k=g.tree("find",d[e.treeParentField]),g.tree("append",{parent:k?k.target:null,data:[{id:f,text:d[e.treeTextField]}]}))}e.onSave.call(a,c,d)}},"json"):e.onSave.call(a,c,d);e.onAfterEdit&&e.onAfterEdit.call(a,c,d)},onCancelEdit:function(c,d){e.editIndex=-1;d.isNewRecord&&b(this).datagrid("deleteRow",c);e.onCancelEdit&&e.onCancelEdit.call(a,c,d)},onBeforeLoad:function(c){if(0==e.onBeforeLoad.call(a,c))return!1;b(this).edatagrid("cancelRow");if(e.tree){var d=b(e.tree).tree("getSelected");c[e.treeParentField]=d?d.id:void 0}}}));e.tree&&b(e.tree).tree({url:e.treeUrl,onClick:function(c){b(a).datagrid("load")},onDrop:function(c,d,f){c=b(this).tree("getNode",c).id;b.ajax({url:e.treeDndUrl,type:"post",data:{id:d.id,targetId:c,point:f},dataType:"json",success:function(){b(a).datagrid("load")}})}})}var h;b(function(){b(document).unbind(".edatagrid").bind("mousedown.edatagrid",function(a){function f(){var a=b(h);a.length&&(a.edatagrid("saveRow"),h=void 0)}a=b(a.target).closest("div.datagrid-view,div.combo-panel");a.length?a.hasClass("datagrid-view")&&(a=a.children("table"),a.length&&h!=a[0]&&f()):f()})});b.fn.edatagrid=function(a,f){if("string"==typeof a){var e=b.fn.edatagrid.methods[a];return e?e(this,f):this.datagrid(a,f)}a=a||{};return this.each(function(){var c=b.data(this,"edatagrid");c?b.extend(c.options,a):b.data(this,"edatagrid",{options:b.extend({},b.fn.edatagrid.defaults,b.fn.edatagrid.parseOptions(this),a)});m(this)})};b.fn.edatagrid.parseOptions=function(a){return b.extend({},b.fn.datagrid.parseOptions(a),{})};b.fn.edatagrid.methods={options:function(a){return b.data(a[0],"edatagrid").options},enableEditing:function(a){return a.each(function(){b.data(this,"edatagrid").options.editing=!0})},disableEditing:function(a){return a.each(function(){b.data(this,"edatagrid").options.editing=!1})},editRow:function(a,f){return a.each(function(){var a=b(this),c=b.data(this,"edatagrid").options,d=c.editIndex;if(d!=f)if(a.datagrid("validateRow",d))if(0<=d&&0==c.onBeforeSave.call(this,d))setTimeout(function(){a.datagrid("selectRow",d)},0);else{a.datagrid("endEdit",d);a.datagrid("beginEdit",f);c.editIndex=f;h!=this&&b(h).length&&(b(h).edatagrid("saveRow"),h=void 0);c.autoSave&&(h=this);var g=a.datagrid("getRows");c.onEdit.call(this,f,g[f])}else setTimeout(function(){a.datagrid("selectRow",d)},0)})},addRow:function(a,f){return a.each(function(){function a(a,b){void 0==a?(c.datagrid("appendRow",b),d.editIndex=g.length-1):(c.datagrid("insertRow",{index:a,row:b}),d.editIndex=a)}var c=b(this),d=b.data(this,"edatagrid").options;if(0<=d.editIndex){if(!c.datagrid("validateRow",d.editIndex)){c.datagrid("selectRow",d.editIndex);return}if(0==d.onBeforeSave.call(this,d.editIndex)){setTimeout(function(){c.datagrid("selectRow",d.editIndex)},0);return}c.datagrid("endEdit",d.editIndex)}var g=c.datagrid("getRows");"object"==typeof f?a(f.index,b.extend(f.row,{isNewRecord:!0})):a(f,{isNewRecord:!0});c.datagrid("beginEdit",d.editIndex);c.datagrid("selectRow",d.editIndex);if(d.tree){var h=b(d.tree).tree("getSelected");g[d.editIndex][d.treeParentField]=h?h.id:0}d.onAdd.call(this,d.editIndex,g[d.editIndex])})},saveRow:function(a){return a.each(function(){var a=b(this),e=b.data(this,"edatagrid").options;0<=e.editIndex&&(0==e.onBeforeSave.call(this,e.editIndex)?setTimeout(function(){a.datagrid("selectRow",e.editIndex)},0):b(this).datagrid("endEdit",e.editIndex))})},cancelRow:function(a){return a.each(function(){var a=b.data(this,"edatagrid").options;0<=a.editIndex&&b(this).datagrid("cancelEdit",a.editIndex)})},destroyRow:function(a,f){return a.each(function(){function a(a){var e=c.datagrid("getRowIndex",a);if(-1!=e)if(a.isNewRecord)c.datagrid("cancelEdit",e);else if(d.destroyUrl){var f=a[d.idField||"id"];b.post(d.destroyUrl,{id:f},function(e){var g=c.datagrid("getRowIndex",f);if(e.isError)c.datagrid("selectRow",g),d.onError.call(c[0],g,e);else{if(d.tree){c.datagrid("reload");e=b(d.tree);var h=e.tree("find",f);h&&e.tree("remove",h.target)}else c.datagrid("cancelEdit",g),c.datagrid("deleteRow",g);d.onDestroy.call(c[0],g,a);g=c.datagrid("getPager");g.length&&!c.datagrid("getRows").length&&(c.datagrid("options").pageNumber=g.pagination("options").pageNumber,c.datagrid("reload"))}},"json")}else c.datagrid("cancelEdit",e),c.datagrid("deleteRow",e),d.onDestroy.call(c[0],e,a)}var c=b(this),d=b.data(this,"edatagrid").options,g=[];if(void 0==f)g=c.datagrid("getSelections");else for(var h=b.isArray(f)?f:[f],l=0;l<h.length;l++){var k=d.finder.getRow(this,h[l]);k&&g.push(k)}g.length?b.messager.confirm(d.destroyMsg.confirm.title,d.destroyMsg.confirm.msg,function(b){if(b){for(b=0;b<g.length;b++)a(g[b]);c.datagrid("clearSelections")}}):b.messager.show({title:d.destroyMsg.norecord.title,msg:d.destroyMsg.norecord.msg})})}};b.fn.edatagrid.defaults=b.extend({},b.fn.datagrid.defaults,{singleSelect:!0,editing:!0,editIndex:-1,destroyMsg:{norecord:{title:"\u8b66\u544a",msg:"\u8bf7\u81f3\u5c11\u9009\u4e2d\u4e00\u6761"},confirm:{title:"\u63d0\u793a",msg:"\u786e\u5b9a\u5220\u9664\u5417"}},autoSave:!1,url:null,saveUrl:null,updateUrl:null,destroyUrl:null,tree:null,treeUrl:null,treeDndUrl:null,treeTextField:"name",treeParentField:"parentId",onAdd:function(a,b){},onEdit:function(a,b){},onBeforeSave:function(a){},onSave:function(a,b){},onDestroy:function(a,b){},onError:function(a,b){}})})(jQuery);